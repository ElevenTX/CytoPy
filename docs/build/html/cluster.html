

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Single-cell phenotype classification by high-dimensional clustering &mdash; CytoPy 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Feature extraction, selection, and summarisation" href="features.html" />
    <link rel="prev" title="Single cell phenotype classification by supervised learning" href="classify.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> CytoPy
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="intro.html#using-python">Using Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#installing-mongodb">Installing MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#installing-cytopy">Installing CytoPy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data uploading</a><ul>
<li class="toctree-l2"><a class="reference internal" href="data.html#connecting-to-the-database">Connecting to the database</a></li>
<li class="toctree-l2"><a class="reference internal" href="data.html#projects-subjects">Projects &amp; Subjects</a></li>
<li class="toctree-l2"><a class="reference internal" href="data.html#adding-cytometry-data">Adding Cytometry data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="data.html#cytometry-panels">Cytometry Panels</a></li>
<li class="toctree-l3"><a class="reference internal" href="data.html#creating-fcsexperiments">Creating FCSExperiments</a></li>
<li class="toctree-l3"><a class="reference internal" href="data.html#adding-fcs-files">Adding *.fcs files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gating.html">Pre-processing with autonomous gates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gating.html#the-gating-and-template-class">The Gating and Template class</a><ul>
<li class="toctree-l3"><a class="reference internal" href="gating.html#plotting-a-population">Plotting a population</a></li>
<li class="toctree-l3"><a class="reference internal" href="gating.html#creating-and-applying-a-gate">Creating and applying a gate</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gating.html#types-of-gates">Types of Gates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="gating.html#densitythreshold">DensityThreshold</a></li>
<li class="toctree-l3"><a class="reference internal" href="gating.html#quantile">Quantile</a></li>
<li class="toctree-l3"><a class="reference internal" href="gating.html#densityclustering">DensityClustering</a></li>
<li class="toctree-l3"><a class="reference internal" href="gating.html#mixturemodel">MixtureModel</a></li>
<li class="toctree-l3"><a class="reference internal" href="gating.html#static">Static</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gating.html#using-control-data">Using control data</a></li>
<li class="toctree-l2"><a class="reference internal" href="gating.html#editing-gate">Editing gate</a></li>
<li class="toctree-l2"><a class="reference internal" href="gating.html#other-worthy-mentions">Other worthy mentions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Batch-effect analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="batch.html#choosing-a-reference-sample">Choosing a reference sample</a></li>
<li class="toctree-l2"><a class="reference internal" href="batch.html#evaluatebatcheffects">EvaluateBatchEffects</a></li>
<li class="toctree-l2"><a class="reference internal" href="batch.html#visualising-univariant-differences">Visualising univariant differences</a></li>
<li class="toctree-l2"><a class="reference internal" href="batch.html#visualising-multivariant-differences">Visualising multivariant differences</a></li>
<li class="toctree-l2"><a class="reference internal" href="batch.html#building-a-similarity-matrix">Building a similarity matrix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="classify.html">Supervised cell classification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="classify.html#introducing-the-cellclassifier">Introducing the CellClassifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="classify.html#training">Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="classify.html#validating">Validating</a></li>
<li class="toctree-l2"><a class="reference internal" href="classify.html#troubleshooting-with-backgating">Troubleshooting with backgating</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">High-dimensional clustering</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-clusteringdefinition">The ClusteringDefinition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#singleclustering">SingleClustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#introducing-exploratory-data-analysis-with-explorer">Introducing exploratory data analysis with Explorer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metaclustering">MetaClustering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Feature extraction, selection, and description</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.fcs.html">cytopy.data.fcs</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.fcs_experiments.html">cytopy.data.fcs_experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.gating.html">cytopy.data.gating</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.mongo_setup.html">cytopy.data.mongo_setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.panel.html">cytopy.data.panel</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.project.html">cytopy.data.project</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.subject.html">cytopy.data.subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.data.utilities.html">cytopy.data.utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.base.html">cytopy.flow.gating.base</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.actions.html">cytopy.flow.gating.actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.plotting.html">cytopy.flow.gating.plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.dbscan.html">cytopy.flow.gating.dbscan</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.defaults.html">cytopy.flow.gating.defaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.density.html">cytopy.flow.gating.density</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.mixturemodel.html">cytopy.flow.gating.mixturemodel</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.quantile.html">cytopy.flow.gating.quantile</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.static.html">cytopy.flow.gating.static</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.gating.utilities.html">cytopy.flow.gating.utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.supervised.html">cytopy.flow.supervised</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.clustering.html">cytopy.flow.clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.batch_effects.html">cytopy.flow.batch_effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.dim_reduction.html">cytopy.flow.dim_reductions</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.feature_extraction.html">cytopy.flow.feature_extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.feedback.html">cytopy.flow.feedback</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.read_write.html">cytopy.flow.read_write</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.transforms.html">cytopy.flow.transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/cytopy.flow.utilities.html">cytopy.flow.utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CytoPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Single-cell phenotype classification by high-dimensional clustering</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/cluster.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="single-cell-phenotype-classification-by-high-dimensional-clustering">
<h1>Single-cell phenotype classification by high-dimensional clustering<a class="headerlink" href="#single-cell-phenotype-classification-by-high-dimensional-clustering" title="Permalink to this headline">¶</a></h1>
<p>CytoPy supports the application of a clustering algorithm to any population, seperating cells into clusters of similar phenotype in high dimensional space. Currently CytoPy supports PhenoGraph clustering and FlowSOM. Clustering is implemented using the <strong>Clustering</strong> class and clusters are saved to the <strong>Population</strong> of each biological sample. Multiple instances of a clustering algorithm can be applied to the same population and the design of the MongoDB database makes it easy to contrast and compare populations (produced from both autonomous/manual gates and from supervised classifiers) with the results of clustering algorithms.</p>
<div class="section" id="the-clusteringdefinition">
<h2>The ClusteringDefinition<a class="headerlink" href="#the-clusteringdefinition" title="Permalink to this headline">¶</a></h2>
<p>We mentioned that multiple clustering algorithms can be applied to a <strong>Population</strong> and their results saved to the database. This is made possible because of the <strong>ClusteringDefinition</strong> class. Before we apply any clustering algorithm to a <strong>Population</strong> we first create a <strong>ClusteringDefinition</strong>. This can be thought of as a “clustering experiment design”. It contains all the information necessary to replicate a clustering analysis: the algorithm to use, the hyperparameters, and the population the algorithm is applied to. The <strong>ClusteringDefinition</strong> is saved to the underlying database and can be reloaded and reused. A reference to the <strong>ClusteringDefinition</strong> is saved to each cluster produced as a result of that defintion. Therefore, when we want to reload clusters from a <strong>Population</strong> to visualise or interpret, we simply provide the ID for the <strong>ClusteringDefinition</strong> and all associated clusters are returned.</p>
<p>We create a <strong>ClusteringDefinition</strong> like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cytopy.flow.clustering.main</span> <span class="kn">import</span> <span class="n">ClusteringDefinition</span>
<span class="n">cd</span> <span class="o">=</span> <span class="n">ClusteringDefinition</span><span class="p">(</span><span class="n">clustering_uid</span><span class="o">=</span><span class="s1">&#39;Tcell_clustering&#39;</span><span class="p">,</span>
                          <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                          <span class="n">method</span><span class="o">=</span><span class="s1">&#39;PhenoGraph&#39;</span><span class="p">,</span>
                          <span class="n">transform_method</span><span class="o">=</span><span class="s1">&#39;logicle&#39;</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)],</span>
                          <span class="n">root_population</span><span class="o">=</span><span class="s1">&#39;T cells&#39;</span><span class="p">)</span>
<span class="n">cd</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>We provide the definition with a unique identifier, this is who we will reload the definition later and also the key associated to produced clusters saved within a <strong>Population</strong>. We provide a list of features, these are variables measured in each fcs file that will be used as features in the clustering algorithm e.g [‘CD3’, ‘CD4’, ‘CD8’, CD161’….]. We specify the method i.e. the algorithm we wish to use; currently ‘PhenoGraph’ and ‘FlowSOM’ are supported but future releases could include new algorithms. The ‘parameters’ argument contains a list of tuples where for each tuple the first element is the name of a valid hyperparameter for the chosen algorithm and the second value the value to use for that hyperparameter. Finally, we provide the cell population we want to perform clustering on whenever this definition is used.</p>
<p>The <strong>ClusteringDefinition</strong> above would be applied to single samples and would execture PhenoGraph clustering with the defined hyperparameters producing clusters from the T cell population. Later on we will see ‘meta-clustering’, where a concensus of the clustering results from many biological samples is made by ‘clustering the clusters’. Meta-clustering also requires a <strong>ClusteringDefinition</strong>. For meta-clustering we would define like above, but include additional parameters:</p>
<ul class="simple">
<li><p>meta_method: a boolean argument that defaults to False, if True, the definiton is treated as though it is for meta-clustering</p></li>
<li><p>meta_clustering_uid_target: the name of the <strong>ClusteringDefinition</strong> for which clusters should be obtained and a consensus found</p></li>
</ul>
<p>An example of creating a meta-clustering <strong>ClusteringDefinition</strong> is given below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the clustering definition from above</span>
<span class="n">target_cd</span> <span class="o">=</span> <span class="n">ClusteringDefinition</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">clustering_uid</span><span class="o">=</span><span class="s1">&#39;Tcell_clustering&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">cd</span> <span class="o">=</span> <span class="n">ClusteringDefinition</span><span class="p">(</span><span class="n">clustering_uid</span><span class="o">=</span><span class="s1">&#39;Meta_T&#39;</span><span class="p">,</span>
                          <span class="n">features</span><span class="o">=</span><span class="n">target_cd</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                          <span class="n">method</span><span class="o">=</span><span class="s1">&#39;PhenoGraph&#39;</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)],</span>
                          <span class="n">root_population</span><span class="o">=</span><span class="s1">&#39;T cells&#39;</span><span class="p">,</span>
                          <span class="n">meta_method</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">meta_clustering_uid_target</span><span class="o">=</span><span class="n">target_cd</span><span class="o">.</span><span class="n">clustering_uid</span><span class="p">)</span>
<span class="n">cd</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="singleclustering">
<h2>SingleClustering<a class="headerlink" href="#singleclustering" title="Permalink to this headline">¶</a></h2>
<p>When we want to perform clustering analysis for a single sample, we use the <strong>SingleClustering</strong> class. This, like all clustering classes, inherits from the base class <strong>Clustering</strong>. Performing clustering is very simple. Once we have a <strong>ClusteringDefinition</strong> we initiate our clustering object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cytopy.flow.clustering.main</span> <span class="kn">import</span> <span class="n">SingleClustering</span>
<span class="n">cd</span> <span class="o">=</span> <span class="n">ClusteringDefinition</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">clustering_uid</span><span class="o">=</span><span class="s1">&#39;Tcell_clustering&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">scluster</span> <span class="o">=</span> <span class="n">SingleClustering</span><span class="p">(</span><span class="n">clustering_definition</span><span class="o">=</span><span class="n">cd</span><span class="p">)</span>
</pre></div>
</div>
<p>We then populate this object with a biological sample from some experiment of interest:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cytopy.data.project</span> <span class="kn">import</span> <span class="n">Project</span>
<span class="n">pd_project</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="s1">&#39;Peritonitis&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">experiment</span> <span class="o">=</span> <span class="n">pd_project</span><span class="o">.</span><span class="n">load_experiment</span><span class="p">(</span><span class="s1">&#39;PD_T_PDMCs&#39;</span><span class="p">)</span>
<span class="c1"># Just load the first sample from out experiment</span>
<span class="n">scluster</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span> <span class="n">sample_id</span><span class="o">=</span><span class="n">experiment</span><span class="o">.</span><span class="n">list_samples</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>The data from this sample is stored within a Pandas DataFrame under the attribute <em>scluster.data</em>. We simply call the <em>cluster</em> method to perform clustering as defined in the <strong>ClusteringDefinition</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scluster</span><span class="o">.</span><span class="n">cluster</span><span class="p">()</span>
</pre></div>
</div>
<p>The cluster results are stored within a dictionary object in <em>scluster.clusters</em>, where the key corresponds to the cluster ID and the value the index of cells that belong to the cluster. When we save the cluster results to the database like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scluster</span><span class="o">.</span><span class="n">save_clusters</span><span class="p">()</span>
</pre></div>
</div>
<p>The clusters are saved to the <strong>Population</strong> called ‘T cells’ as specified in the <strong>ClusteringDefinition</strong>.</p>
<p>If we want to jump in and explore our clustering results however, we can do so using the <strong>Explorer</strong> class…</p>
</div>
<div class="section" id="introducing-exploratory-data-analysis-with-explorer">
<h2>Introducing exploratory data analysis with Explorer<a class="headerlink" href="#introducing-exploratory-data-analysis-with-explorer" title="Permalink to this headline">¶</a></h2>
<p>The <strong>Explorer</strong> class is the ultimate tool of explroatory data analysis in CytoPy. Every clustering class in CytoPy has a method called <em>explorer</em> that generates an <strong>Explorer</strong> object. The <strong>Explorer</strong> can be thought of as a wrapper to a Pandas DataFrame that brings immense data wrangling and visualisation power. <strong>Explorer</strong> houses either single cell data from a single biological sample or the results of meta-clustering in it’s <em>data</em> attribute. It then contains many methods for visualising this data and exploring it interactively, as well as relating this data to patient metadata.</p>
<p>When the <strong>Explorer</strong> object is generated the data is populated with labels of the clustering results, <strong>Population</strong> labels for each single cell, and identifiers that relate each single cell back to the biological subject it originated from. Let’s see an example of <strong>Explorer</strong> in action:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate the Explorer object</span>
<span class="n">explorer</span> <span class="o">=</span> <span class="n">scluster</span><span class="o">.</span><span class="n">explorer</span><span class="p">()</span>
</pre></div>
</div>
<p>We can generate a dimensionality reduction plot using any of the methods in cytopy.flow.dim_reduction (Linear PCA, non-linear PCA, UMAP, t-SNE, Isomap, and PHATE). We can specify to plot two components as a static two dimensional scatter plot or three components that will render automatically as a three-dimensional interactive plot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explorer</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span>
                      <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CXCR3&#39;</span><span class="p">,</span> <span class="s1">&#39;CD161&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;CCR7&#39;</span><span class="p">,</span> <span class="s1">&#39;Va7-2&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;Vd2&#39;</span><span class="p">,</span> <span class="s1">&#39;CD45RA&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;PanGD&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4&#39;</span><span class="p">,</span><span class="s1">&#39;CD27&#39;</span><span class="p">],</span>
                      <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">dim_reduction_method</span><span class="o">=</span><span class="s1">&#39;PHATE&#39;</span><span class="p">,</span>
                      <span class="n">matplotlib_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">})</span>
</pre></div>
</div>
<img alt="_images/phate_single.png" src="_images/phate_single.png" />
<p>The results of dimensionality reduction are housed within the Pandas DataFrame as additional columns. The Pandas DataFrame can be saved to hard disk using the <em>save</em> method of <strong>Explorer</strong> and then an <strong>Explorer</strong> object created from loading that DataFrame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explorer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;to_use_later.csv&#39;</span><span class="p">)</span>
<span class="n">explorer</span> <span class="o">=</span> <span class="n">Explorer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;to_use_later.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If we want to contrast the results of our clustering analysis with the results of a supervised classifier like XGBoost, we simply change the variable we want to label data points with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explorer</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;population_label&#39;</span><span class="p">,</span>
                      <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CXCR3&#39;</span><span class="p">,</span> <span class="s1">&#39;CD161&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;CCR7&#39;</span><span class="p">,</span> <span class="s1">&#39;Va7-2&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;Vd2&#39;</span><span class="p">,</span> <span class="s1">&#39;CD45RA&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;PanGD&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4&#39;</span><span class="p">,</span><span class="s1">&#39;CD27&#39;</span><span class="p">],</span>
                      <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">dim_reduction_method</span><span class="o">=</span><span class="s1">&#39;PHATE&#39;</span><span class="p">,</span>
                      <span class="n">matplotlib_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">})</span>
</pre></div>
</div>
<img alt="_images/phate_xgboost.png" src="_images/phate_xgboost.png" />
<p>The performance is greatly increased because dimensionality reduction is only ever performed once and then the results stored and reused whenever the label is changed.</p>
<p>We can observe the phenotype of each cluster by using the <em>heatmap</em> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explorer</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">heatmap_var</span><span class="o">=</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span>
                 <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CXCR3&#39;</span><span class="p">,</span> <span class="s1">&#39;CD161&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;CCR7&#39;</span><span class="p">,</span> <span class="s1">&#39;Va7-2&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;Vd2&#39;</span><span class="p">,</span> <span class="s1">&#39;CD45RA&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;PanGD&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4&#39;</span><span class="p">,</span><span class="s1">&#39;CD27&#39;</span><span class="p">],</span>
                <span class="n">clustermap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/single_heatmap.png" src="_images/single_heatmap.png" />
</div>
<div class="section" id="metaclustering">
<h2>MetaClustering<a class="headerlink" href="#metaclustering" title="Permalink to this headline">¶</a></h2>
<p>Once we have the clustering results for each biological sample in an experiment, we want to be able to group similar clusters between samples and observe them in the same space. Our manuscript (LINK) describes the methodology applied here in detail but in brief, the centroid for each cluster from each biological sample is calculated and the centroids are then clustered. This operation is handled by <strong>MetaClustering</strong>. The steps in code are very similar to <strong>SingleClustering</strong> except now we have to specify which samples we want to load:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">=</span> <span class="n">ClusteringDefinition</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">clustering_uid</span><span class="o">=</span><span class="s1">&#39;Meta_T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">MetaClustering</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                      <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
                      <span class="n">clustering_definition</span><span class="o">=</span><span class="n">cd</span><span class="p">)</span>
<span class="n">meta</span><span class="o">.</span><span class="n">cluster</span><span class="p">()</span>
</pre></div>
</div>
<p>The results are stored as a Pandas DataFrame, just like before. We can also create an <strong>Explorer</strong> object and explore the results of our meta clustering. Let’s produce a heatmap of the phenotype of our meta-clusters. Remember, these clusters now represent the consensus of all our biological samples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explore</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">explorer</span><span class="p">()</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">features</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FSC-A&#39;</span><span class="p">,</span> <span class="s1">&#39;SSC-A&#39;</span><span class="p">]]</span>
<span class="n">explore</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">heatmap_var</span><span class="o">=</span><span class="s1">&#39;meta_cluster_id&#39;</span><span class="p">,</span>
        <span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">clustermap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">col_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<img alt="_images/single_heatmap.png" src="_images/single_heatmap.png" />
<p>It would be great if we could provide our clusters with more familar names. We can do this using the <em>label_cluster</em> method of our <strong>MetaClustering</strong> class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="o">.</span><span class="n">label_cluster</span><span class="p">(</span><span class="s1">&#39;cluster_4&#39;</span><span class="p">,</span> <span class="s1">&#39;MAITs&#39;</span><span class="p">)</span>
<span class="n">meta</span><span class="o">.</span><span class="n">label_cluster</span><span class="p">(</span><span class="s1">&#39;cluster_9&#39;</span><span class="p">,</span> <span class="s1">&#39;γδ T cells&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This can be done for each of our meta clusters. We can save the results of meta clusters to our database. Each cluster, for each biological sample, will have a field called “meta_cluster_id” that refers to it’s associated meta cluster. Clusters can even be associated to multiple meta clusters at once, as this meta cluster ID is linked to the <strong>ClusteringDefinition</strong> that produced the meta cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>If meta clustering results already exist for an experiment, we can load the existing meta clustering results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="n">MetaClustering</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                      <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
                      <span class="n">clustering_definition</span><span class="o">=</span><span class="n">cd</span><span class="p">,</span>
                      <span class="n">load_existing_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s use the <strong>Explorer</strong> class to explore the newly labelled meta clusters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explore</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">explorer</span><span class="p">()</span>
<span class="n">explore</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">heatmap_var</span><span class="o">=</span><span class="s1">&#39;meta_cluster_id&#39;</span><span class="p">,</span>
                <span class="n">clustermap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">col_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
                <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/meta_heatmap_2.png" src="_images/meta_heatmap_2.png" />
<p>The plots of CytoPy use common libraries:
* Heatmaps are produced using Seaborn
* Scatterplots in <strong>Explorer</strong> are produced using Scprep
* All other plots use Matplotlib</p>
<p>Additional keyword arguments that are common to these libraries can be given and will be passed to the call to Seaborn/Scprep/Matplotlib.</p>
<p>We can visualise meta clusters as a scatter plot where all clusters from all biological samples are shown after dimensionality reduction. The colour of the data point corresponds to it’s meta cluster assignement and the size of the data point the proportion of cellular events relative to the biological sample the cluster originated from. The size of data points can be controlled using the ‘meta_scale_factor’ argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explore</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;meta_cluster_id&#39;</span><span class="p">,</span>
                     <span class="n">features</span><span class="o">=</span><span class="n">cd</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                     <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">meta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">meta_scale_factor</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
                     <span class="n">matplotlib_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                     <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                     <span class="n">dim_reduction_method</span><span class="o">=</span><span class="s1">&#39;UMAP&#39;</span><span class="p">})</span>
</pre></div>
</div>
<img alt="_images/meta_umap.png" src="_images/meta_umap.png" />
<p>The crown jewl of CytoPy is its ability to easily and rapidly relate the results of complex cytometry analysis to the underlying clinical or experimental meta data. In the <strong>Explorer</strong> class we can load meta data using the <em>load_meta</em> method. We provide any field name in the <strong>Subject</strong> document that a column is amended to the Pandas DataFrame for that variable. Additionally we can load drug data, infection data, and other embedded data where multiple events of a variable exist for one patient (see cytopy.flow.clustering.main.Explorer).</p>
<p>Below is an example of loading the peritonitis variables, which specifies if a patient has peritonitis or not. We can then colour clusters according to this variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">explore</span><span class="o">.</span><span class="n">load_meta</span><span class="p">(</span><span class="s1">&#39;peritonitis&#39;</span><span class="p">)</span>
<span class="n">explore</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;peritonitis&#39;</span><span class="p">,</span>
                     <span class="n">features</span><span class="o">=</span><span class="n">cd</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                     <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">meta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">meta_scale_factor</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
                     <span class="n">matplotlib_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                     <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                     <span class="n">dim_reduction_method</span><span class="o">=</span><span class="s1">&#39;UMAP&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/meta_umap_meta.png" src="_images/meta_umap_meta.png" />
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="features.html" class="btn btn-neutral float-right" title="Feature extraction, selection, and summarisation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="classify.html" class="btn btn-neutral float-left" title="Single cell phenotype classification by supervised learning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ross Burton

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>